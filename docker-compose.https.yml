version: '3.8'

services:
  kasa-monitor:
    build: .
    ports:
      - "443:443"        # Map standard HTTPS port
      - "80:5272"        # Map HTTP port for non-SSL
    environment:
      - HTTPS_PORT=443   # Configure HTTPS port (default: 5273)
      - SSL_CERT_PATH=/app/ssl/server.crt
      - SSL_KEY_PATH=/app/ssl/server.key
    volumes:
      - ./ssl:/app/ssl:ro              # Mount SSL certificates (read-only)
      - ./data:/app/data               # Mount data directory
      - kasa_db:/app/kasa_monitor.db   # Database volume
    restart: unless-stopped
    
  # Optional: reverse proxy for better SSL management
  nginx:
    image: nginx:alpine
    ports:
      - "443:443"
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/ssl/certs:ro
    depends_on:
      - kasa-monitor
    restart: unless-stopped

volumes:
  kasa_db:

# Example nginx.conf for reverse proxy:
# server {
#     listen 443 ssl;
#     server_name your-domain.com;
#     
#     ssl_certificate /etc/ssl/certs/server.crt;
#     ssl_certificate_key /etc/ssl/certs/server.key;
#     
#     location / {
#         proxy_pass https://kasa-monitor:5273;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#     }
# }